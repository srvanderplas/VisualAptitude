# setwd("~/Dropbox/GraphicsGroup/TestingVisualAptitude/")

ans <- read.csv(paste0(datadir, "VisualGraphicsData.csv"), na.strings=c(" ", ""), stringsAsFactors=F)
ans$id <- 1:nrow(ans)

key <- ans[1,]
key[,1:19] <- NA
# Visual Search
key[,20:44] <- c(17, 12, 15, 14, 8, 21, 6, 3, 21, 22, 4, 23, 9, 8, 22, 13, 2, 19, 16, 18, 7, 16, 12, 1, 7)
# Lineups 1
key[,45:64] <- c(6, 16, 13, 10, 17, 6, 16, 13, 10, 17, 6, 16, 13, 10, 17, 6, 16, 13, 10, 17)
# Card  Rotation
key[,65:224] <- c("d", "s", "s", "d", "d", "s", "d", "s",  "s", "s", "s", "d", "s", "s", "s", "s", 
                  "s", "d", "d", "d", "s", "s", "s", "d",  "s", "s", "d", "s", "d", "d", "d", "s",
                  "d", "s", "d", "d", "s", "s", "d", "s",  "s", "d", "s", "s", "s", "s", "d", "d", 
                  "s", "d", "s", "d", "d", "s", "s", "s",  "d", "d", "s", "s", "d", "s", "d", "d", 
                  "d", "d", "s", "s", "d", "s", "s", "d",  "s", "d", "d", "s", "d", "d", "s", "s",
                  "s", "s", "d", "d", "s", "s", "d", "d",  "s", "d", "d", "d", "s", "s", "s", "s",
                  "d", "d", "s", "s", "s", "s", "s", "d",  "s", "d", "s", "s", "d", "d", "d", "s",
                  "s", "s", "s", "d", "d", "d", "s", "s",  "d", "s", "s", "d", "s", "d", "d", "d",
                  "s", "s", "d", "d", "d", "d", "d", "s",  "s", "s", "s", "s", "d", "d", "s", "s",
                  "s", "s", "d", "d", "d", "d", "d", "s",  "s", "d", "d", "d", "s", "s", "s", "s")
# Lineups 2
key[,225:244] <- c(15, 15, 15,  4,  6,   15,  6, 15,  4,  6,   6,  6,  4,  4, 15,   4, 15, 15, 15, 15)

# Figure Classification
key[,245:356] <- c(2, 1, 1, 2, 1, 2, 2, 2,  2, 1, 2, 1, 2, 1, 2, 2, 
                   1, 2, 2, 1, 2, 2, 1, 2,  2, 1, 1, 2, 2, 1, 2, 1, 
                   2, 1, 2, 1, 1, 2, 1, 1,  2, 1, 2, 1, 1, 2, 2, 1, 
                   1, 2, 1, 2, 1, 2, 1, 1,  1, 2, 2, 2, 1, 1, 2, 2, 
                   3, 2, 2, 1, 2, 1, 1, 3,  1, 3, 1, 2, 3, 3, 2, 3, 
                   2, 3, 2, 1, 2, 1, 3, 3,  2, 1, 2, 2, 1, 3, 1, 3, 
                   2, 2, 1, 3, 3, 1, 1, 1,  3, 1, 2, 3, 1, 3, 2, 2)

# Lineups 3
key[,357:376] <- c(12, 19, 14,  4, 13, 
                    4, 14,  7,  8, 19, 
                    8, 19, 12, 18, 12, 
                    7,  7,  6,  6,  5)

# Paper Folding
key[,377:396] <- c("a", "d", "b", "d", "b", 
                   "e", "a", "c", "e", "e", 
                   "c", "b", "a", "e", "b", 
                   "a", "e", "d", "d", "c")

library(plyr)
scored <- ddply(ans, .(id), function(j) as.numeric(j==key) + c(0, NA)[1+is.na(j)])
names(scored) <- names(ans)
scored[,1:19] <- ans[,1:19]
# scored[,357:376] <- NA # can't find answers for Lineup3?
scored[,20:396] <- apply(scored[,20:396], 2, as.numeric)

library(reshape2)
library(stringr)
longform <- melt(scored[,c(1, 20:396)], id.vars=1)
longform$testtype <- gsub("_q[0123456789]+[abcdefgh]?$", "", longform$variable)
longform$testnum <- as.numeric(gsub("[[:alpha:]_]+", "", longform$testtype))
longform$testtype <- gsub("[[:digit:]]", "", longform$testtype)
longform$qnum <- as.numeric(str_replace(str_extract(longform$variable, "q\\d{1,2}"), fixed("q"), ""))
longform$penalty <- 0
longform$penalty[longform$testtype=="vis_search"] <- 1/23
longform$penalty[longform$testtype=="lineup"] <- 1/19
longform$penalty[longform$testtype=="card_rot"] <- 1
longform$penalty[longform$testtype=="folding"] <- 1/4
longform$penalty[longform$testtype=="fig_class" & longform$qnum<=8] <- 1
longform$penalty[longform$testtype=="fig_class" & longform$qnum>8] <- 1/2

qrange <- ddply(subset(longform, id==1), .(testtype), summarize, min.score=sum(penalty), max.score=length(testtype))

longform.sum <- ddply(longform, .(id, testtype), summarize, 
                      pos.pts = ifelse(is.numeric(value), sum(value, na.rm=T), unique(value)),
                      neg.pts = ifelse(is.numeric(value), sum((1-value)*penalty, na.rm=T), unique(value)),
                      pct.answered=sum(!is.na(value))/length(value))
longform.sum <- merge(longform.sum, qrange)

longform.sum$value <- with(longform.sum, (pos.pts - neg.pts + min.score)/(min.score+max.score)*100)

# longform.sum$value[longform.sum$testtype=="lineup" & longform.sum$testnum==3] <- NA
ans.summary <- dcast(longform.sum, id~testtype, value.var="value", na.rm=TRUE)
ans.summary <- merge(ans[,1:19], ans.summary)
# ans.summary2 <- dcast(longform.sum, id~testtype+testnum, value.var = "value")
# ans.summary2 <- merge(ans[,1:19], ans.summary2)
pct.ans <- dcast(longform.sum, id~testtype, value.var="pct.answered")

ans.summary$vidgame_hrs_factor <- ordered(factor(rowSums(sapply(c(-1, 0, 1.99, 4.99), function(i) ans$vidgame_hrs>i)), labels=c("0", "[1, 2)", "[2, 5)", "5+"), levels=1:4))
# ans.summary$log_vidgame_hrs <- log10(ans.summary$vidgame_hrs+1)
# 
# qplot(data=ans.summary, x=card_rot, y=lineup, geom="point")
# 
# qplot(data=ans.summary, x=folding, y=lineup, geom="point") 
# 
# qplot(data=ans.summary, x=fig_class, y=lineup, geom="point")
# 
# qplot(data=ans.summary, x=vis_search, y=lineup, geom="point")
# 

lineup.summary <- melt(ans.summary, id.vars=c(1:19, 23, 25))


# qplot(data=lineup.summary, x=value, y=lineup, geom="point") + facet_wrap(~variable) + xlim(c(0,100))

lineup.summary.categorical <- melt(ans.summary[,c(1:3, 12:17, 19, 23, 25)], id.vars=c("id", "lineup"))
